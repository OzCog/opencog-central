<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AtomSpace WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background-color: #005a9e; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        input[type="text"] {
            width: 300px;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .atoms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .atom-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
        }
        .atom-type { font-weight: bold; color: #007acc; }
        .atom-name { color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AtomSpace WebSocket API Test</h1>
            <p>Test the modern AtomSpace WebSocket API connection</p>
        </div>

        <div class="connection-section">
            <h3>Connection</h3>
            <div>
                <input type="text" id="wsUrl" value="ws://localhost:18080/json" placeholder="WebSocket URL">
                <button onclick="connect()">Connect</button>
                <button onclick="disconnect()">Disconnect</button>
            </div>
            <div id="connectionStatus" class="status info">Not connected</div>
        </div>

        <div class="test-section">
            <h3>API Tests</h3>
            <button onclick="getVersion()" disabled id="versionBtn">Get Version</button>
            <button onclick="getAllAtoms()" disabled id="atomsBtn">Get All Atoms</button>
            <button onclick="createSampleAtom()" disabled id="createBtn">Create Sample Atom</button>
            <button onclick="testRawCommand()" disabled id="rawBtn">Send Raw Command</button>
        </div>

        <div class="output-section">
            <h3>Console Output</h3>
            <div id="console" class="output">Ready to connect...</div>
        </div>

        <div class="atoms-section">
            <h3>Retrieved Atoms</h3>
            <div id="atomsDisplay" class="atoms-grid"></div>
        </div>
    </div>

    <script>
        let websocket = null;
        let isConnected = false;

        function log(message) {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            console.textContent += `[${timestamp}] ${message}\n`;
            console.scrollTop = console.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('connectionStatus');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function updateButtons(connected) {
            const buttons = ['versionBtn', 'atomsBtn', 'createBtn', 'rawBtn'];
            buttons.forEach(id => {
                document.getElementById(id).disabled = !connected;
            });
        }

        function connect() {
            const url = document.getElementById('wsUrl').value;
            
            if (websocket) {
                disconnect();
            }

            log(`Attempting to connect to: ${url}`);
            updateStatus('Connecting...', 'warning');

            try {
                websocket = new WebSocket(url);

                websocket.onopen = function() {
                    log('✓ Connected to AtomSpace WebSocket');
                    updateStatus('Connected', 'success');
                    isConnected = true;
                    updateButtons(true);
                };

                websocket.onmessage = function(event) {
                    log(`R> ${event.data}`);
                    handleResponse(event.data);
                };

                websocket.onerror = function(error) {
                    log(`✗ WebSocket error: ${error}`);
                    updateStatus('Connection error', 'error');
                    isConnected = false;
                    updateButtons(false);
                };

                websocket.onclose = function() {
                    log('Connection closed');
                    updateStatus('Disconnected', 'info');
                    isConnected = false;
                    updateButtons(false);
                };

            } catch (error) {
                log(`✗ Failed to connect: ${error.message}`);
                updateStatus('Connection failed', 'error');
            }
        }

        function disconnect() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            isConnected = false;
            updateButtons(false);
        }

        function sendCommand(command) {
            if (!isConnected || !websocket) {
                log('✗ Not connected to WebSocket');
                return;
            }

            log(`S> ${command}`);
            websocket.send(command);
        }

        function handleResponse(data) {
            try {
                // Try to parse as JSON
                const trimmedResponse = trimTrailJson(data);
                let parsedData;
                
                try {
                    parsedData = JSON.parse(trimmedResponse);
                } catch (e) {
                    // If it's not JSON, display as text
                    parsedData = trimmedResponse;
                }

                if (Array.isArray(parsedData)) {
                    displayAtoms(parsedData);
                }
            } catch (error) {
                log(`Error processing response: ${error.message}`);
            }
        }

        function trimTrailJson(res) {
            const trailingString = res.substring(res.length - 6);
            if (trailingString.includes('json')) {
                return res.substring(0, res.length - 6);
            }
            return res;
        }

        // Escapes HTML special characters to prevent XSS
        function escapeHTML(str) {
            return String(str).replace(/[&<>"'\/]/g, function (s) {
                switch (s) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#39;';
                    case '/': return '&#x2F;';
                    default: return s;
                }
            });
        }

        function displayAtoms(atoms) {
            const display = document.getElementById('atomsDisplay');
            display.innerHTML = '';

            if (!Array.isArray(atoms) || atoms.length === 0) {
                display.innerHTML = '<p>No atoms to display</p>';
                return;
            }

            atoms.forEach((atom, index) => {
                const card = document.createElement('div');
                card.className = 'atom-card';
                
                let content = `<div class="atom-type">${escapeHTML(atom.type || 'Unknown')}</div>`;
                if (atom.name) {
                    content += `<div class="atom-name">${escapeHTML(atom.name)}</div>`;
                }
                if (atom.outgoing && atom.outgoing.length > 0) {
                    // outgoing.length should be a number, but escape just in case
                    content += `<div>Outgoing: ${escapeHTML(atom.outgoing.length)}</div>`;
                }
                
                card.innerHTML = content;
                display.appendChild(card);
            });

            log(`✓ Displayed ${atoms.length} atoms`);
        }

        function getVersion() {
            sendCommand('AtomSpace.version()');
        }

        function getAllAtoms() {
            sendCommand('AtomSpace.getAtoms("Atom",true)');
        }

        function createSampleAtom() {
            const sampleAtom = {
                type: 'ConceptNode',
                name: 'TestAtom_' + Date.now()
            };
            sendCommand(`AtomSpace.makeAtom(${JSON.stringify(sampleAtom)})`);
        }

        function testRawCommand() {
            const command = prompt('Enter raw command:', 'AtomSpace.getAtoms("ConceptNode",true)');
            if (command) {
                sendCommand(command);
            }
        }

        // Load sample data for testing
        function loadSampleData() {
            const sampleAtoms = [
                { type: 'ConceptNode', name: 'human' },
                { type: 'ConceptNode', name: 'Socrates' },
                { type: 'ConceptNode', name: 'man' },
                { type: 'ConceptNode', name: 'mortal' },
                {
                    type: 'InheritanceLink',
                    outgoing: [
                        { type: 'ConceptNode', name: 'Socrates' },
                        { type: 'ConceptNode', name: 'man' }
                    ]
                }
            ];
            displayAtoms(sampleAtoms);
            log('✓ Loaded sample data for display');
        }

        // Initialize with sample data
        window.onload = function() {
            log('AtomSpace WebSocket API Test initialized');
            log('1. Enter WebSocket URL (default: ws://localhost:18080/json)');
            log('2. Click Connect to establish connection');
            log('3. Use the API test buttons to interact with AtomSpace');
            loadSampleData();
        };
    </script>
</body>
</html>